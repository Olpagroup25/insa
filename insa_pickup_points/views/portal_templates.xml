<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ============================================================ -->
    <!-- Portal Home: add "Entregas" card with emoji                  -->
    <!-- ============================================================ -->
    <template id="portal_my_home_pickup"
              name="Portal: Puntos de Retiro"
              inherit_id="portal.portal_my_home"
              priority="40">
        <xpath expr="//div[hasclass('o_portal_docs')]" position="inside">
            <t t-call="portal.portal_docs_entry">
                <t t-set="icon" t-value="'/insa_pickup_points/static/src/img/pickup_icon.svg'"/>
                <t t-set="title">ðŸ“¦ Entregas en Punto de Retiro</t>
                <t t-set="text">Ver y confirmar entregas asignadas</t>
                <t t-set="url" t-value="'/my/pickup/orders'"/>
                <t t-set="placeholder_count" t-value="'pickup_count'"/>
            </t>
        </xpath>
    </template>

    <!-- ============================================================ -->
    <!-- List View: /my/pickup/orders                                 -->
    <!-- ============================================================ -->
    <template id="portal_pickup_orders" name="Portal: Entregas Punto de Retiro">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="1"/>

            <t t-call="portal.portal_searchbar">
                <t t-set="title">Entregas en Punto de Retiro</t>
            </t>

            <!-- Custom breadcrumb -->
            <nav class="insa-breadcrumb">
                <a href="/my/home"><i class="fa fa-home"/> Mi cuenta</a>
                <span class="sep"><i class="fa fa-chevron-right"/></span>
                <span class="current"><i class="fa fa-cube"/> Entregas</span>
            </nav>

            <t t-if="not pickings">
                <div class="insa-empty-state">
                    <div class="empty-icon">ðŸ“­</div>
                    <p class="empty-title">Sin entregas</p>
                    <p class="empty-text">No hay entregas asignadas con el filtro seleccionado.</p>
                </div>
            </t>

            <t t-if="pickings">
                <div class="table-responsive">
                    <table class="table table-sm table-striped o_list_table o_portal_my_doc_table insa-table">
                        <thead>
                            <tr>
                                <th>Referencia</th>
                                <th>Cliente</th>
                                <th>Fecha</th>
                                <th class="d-none d-md-table-cell">Origen</th>
                                <th class="text-center">Estado</th>
                                <th class="text-center">ConfirmaciÃ³n</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="pickings" t-as="picking">
                                <tr class="insa-row">
                                    <td>
                                        <a t-attf-href="/my/pickup/orders/#{picking.id}"
                                           class="insa-link fw-medium">
                                            <t t-out="picking.name"/>
                                        </a>
                                    </td>
                                    <td class="text-muted">
                                        <t t-out="picking.partner_id.name"/>
                                    </td>
                                    <td class="text-muted">
                                        <t t-out="picking.scheduled_date" t-options="{'widget': 'date'}"/>
                                    </td>
                                    <td class="text-muted d-none d-md-table-cell">
                                        <t t-out="picking.origin or '-'"/>
                                    </td>
                                    <td class="text-center">
                                        <span t-if="picking.state == 'assigned'"
                                              class="badge rounded-pill insa-badge-ready">
                                            Listo
                                        </span>
                                        <span t-if="picking.state == 'done'"
                                              class="badge rounded-pill insa-badge-done">
                                            Realizado
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <span t-if="picking.pickup_confirmed"
                                              class="badge rounded-pill insa-badge-confirmed">
                                            <i class="fa fa-check"/> Confirmado
                                        </span>
                                        <span t-else=""
                                              class="badge rounded-pill insa-badge-pending">
                                            Pendiente
                                        </span>
                                    </td>
                                </tr>
                            </t>
                        </tbody>
                    </table>
                </div>

                <div t-if="pager" class="o_portal_pager text-center mt-3">
                    <t t-call="portal.pager"/>
                </div>
            </t>
        </t>
    </template>

    <!-- ============================================================ -->
    <!-- Detail View: /my/pickup/orders/<id>                          -->
    <!-- ============================================================ -->
    <template id="portal_pickup_order_detail" name="Portal: Detalle Entrega Punto de Retiro">
        <t t-call="portal.portal_layout">
            <t t-set="o_portal_fullwidth_alert" groups="base.group_user">
                <t t-call="portal.portal_back_in_edit_mode">
                    <t t-set="backend_url"
                       t-value="'/odoo/inventory/delivery/%s' % picking.id"/>
                </t>
            </t>

            <div class="container py-3">
                <!-- Breadcrumb -->
                <nav class="insa-breadcrumb">
                    <a href="/my/home"><i class="fa fa-home"/> Mi cuenta</a>
                    <span class="sep"><i class="fa fa-chevron-right"/></span>
                    <a href="/my/pickup/orders"><i class="fa fa-cube"/> Entregas</a>
                    <span class="sep"><i class="fa fa-chevron-right"/></span>
                    <span class="current"><t t-out="picking.name"/></span>
                </nav>

                <!-- Page header -->
                <div class="insa-page-header">
                    <div class="d-flex align-items-center gap-3 flex-wrap">
                        <div class="header-icon">
                            <i class="fa fa-truck"/>
                        </div>
                        <div class="flex-grow-1">
                            <div class="header-title">
                                <t t-out="picking.name"/>
                            </div>
                            <div class="header-subtitle">
                                <t t-if="picking.origin">
                                    Origen: <t t-out="picking.origin"/>
                                </t>
                            </div>
                        </div>
                        <div>
                            <span t-if="picking.pickup_confirmed"
                                  class="badge rounded-pill insa-badge-confirmed-lg">
                                <i class="fa fa-check-circle"/> Confirmado
                            </span>
                            <span t-else=""
                                  class="badge rounded-pill insa-badge-pending-lg">
                                <i class="fa fa-clock-o"/> Pendiente
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Info cards -->
                <div class="row g-3 mt-1">
                    <div class="col-md-6">
                        <div class="insa-card">
                            <div class="insa-card-header blue">
                                <i class="fa fa-info-circle"/> InformaciÃ³n de la Entrega
                            </div>
                            <div class="insa-card-body">
                                <div class="insa-detail-row">
                                    <span class="label">Referencia</span>
                                    <span class="value"><t t-out="picking.name"/></span>
                                </div>
                                <div class="insa-detail-row">
                                    <span class="label">Origen</span>
                                    <span class="value"><t t-out="picking.origin or '-'"/></span>
                                </div>
                                <div class="insa-detail-row">
                                    <span class="label">Fecha Programada</span>
                                    <span class="value">
                                        <t t-out="picking.scheduled_date"
                                           t-options="{'widget': 'datetime'}"/>
                                    </span>
                                </div>
                                <div class="insa-detail-row">
                                    <span class="label">Estado</span>
                                    <span class="value">
                                        <span t-if="picking.state == 'assigned'"
                                              class="badge rounded-pill insa-badge-ready">Listo</span>
                                        <span t-if="picking.state == 'done'"
                                              class="badge rounded-pill insa-badge-done">Realizado</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="insa-card">
                            <div class="insa-card-header green">
                                <i class="fa fa-user"/> Cliente
                            </div>
                            <div class="insa-card-body">
                                <div class="insa-detail-row">
                                    <span class="label">Nombre</span>
                                    <span class="value"><t t-out="picking.partner_id.name"/></span>
                                </div>
                                <div t-if="picking.partner_id.phone" class="insa-detail-row">
                                    <span class="label">TelÃ©fono</span>
                                    <span class="value"><t t-out="picking.partner_id.phone"/></span>
                                </div>
                                <div t-if="picking.partner_id.mobile" class="insa-detail-row">
                                    <span class="label">Celular</span>
                                    <span class="value"><t t-out="picking.partner_id.mobile"/></span>
                                </div>
                                <div t-if="picking.partner_id.email" class="insa-detail-row">
                                    <span class="label">Email</span>
                                    <span class="value"><t t-out="picking.partner_id.email"/></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Products table -->
                <div class="insa-card mt-3">
                    <div class="insa-card-header dark">
                        <i class="fa fa-cubes"/> Productos a Entregar
                    </div>
                    <div class="insa-card-body p-0">
                        <table class="table table-sm mb-0 insa-products-table">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th class="text-end">Demandada</th>
                                    <th class="text-end">Realizada</th>
                                    <th class="d-none d-md-table-cell">UdM</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="picking.move_ids" t-as="move">
                                    <tr>
                                        <td class="fw-medium"><t t-out="move.product_id.name"/></td>
                                        <td class="text-end">
                                            <t t-out="move.product_uom_qty"
                                               t-options="{'widget': 'float', 'precision': 2}"/>
                                        </td>
                                        <td class="text-end">
                                            <t t-out="move.quantity"
                                               t-options="{'widget': 'float', 'precision': 2}"/>
                                        </td>
                                        <td class="d-none d-md-table-cell text-muted">
                                            <t t-out="move.product_uom.name"/>
                                        </td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Confirmation section -->
                <div class="mt-4">
                    <t t-if="not picking.pickup_confirmed">
                        <div class="insa-confirm-section">
                            <p class="mb-2 text-muted">
                                Â¿El cliente ya retirÃ³ los productos?
                            </p>
                            <button type="button"
                                    class="btn insa-btn-confirm"
                                    data-bs-toggle="modal"
                                    data-bs-target="#confirmPickupModal">
                                <i class="fa fa-check-circle"/> Confirmar Entrega
                            </button>
                        </div>
                    </t>
                    <t t-else="">
                        <div class="insa-confirmed-section">
                            <i class="fa fa-check-circle fa-2x"/>
                            <div>
                                <div class="fw-medium">Entrega confirmada</div>
                                <small class="text-muted">
                                    <t t-out="picking.pickup_confirmed_date"
                                       t-options="{'widget': 'datetime'}"/>
                                    <t t-if="picking.pickup_confirmed_by">
                                        Â· <t t-out="picking.pickup_confirmed_by.name"/>
                                    </t>
                                </small>
                            </div>
                        </div>
                    </t>
                </div>

                <!-- Confirm Modal -->
                <div class="modal fade" id="confirmPickupModal" tabindex="-1"
                     aria-labelledby="confirmPickupLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content insa-modal">
                            <div class="modal-header border-0 pb-0">
                                <div class="modal-icon">ðŸ“¦</div>
                            </div>
                            <div class="modal-body text-center pt-2">
                                <h5 class="mb-2">Confirmar entrega</h5>
                                <p class="text-muted mb-0">
                                    Vas a confirmar que el cliente retirÃ³ los productos
                                    de la entrega <strong><t t-out="picking.name"/></strong>.
                                    <br/>Esta acciÃ³n no se puede deshacer.
                                </p>
                            </div>
                            <div class="modal-footer border-0 justify-content-center gap-2 pt-0">
                                <button type="button" class="btn btn-light px-4"
                                        data-bs-dismiss="modal">
                                    Cancelar
                                </button>
                                <form t-attf-action="/my/pickup/orders/#{picking.id}/confirm"
                                      method="POST" class="d-inline">
                                    <input type="hidden" name="csrf_token"
                                           t-att-value="request.csrf_token()"/>
                                    <button type="submit" class="btn insa-btn-confirm px-4">
                                        <i class="fa fa-check"/> Confirmar
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Success toast (shown via JS after confirmation) -->
                <t t-if="request.params.get('confirmed')">
                    <div class="insa-toast-container">
                        <div class="insa-toast show" role="alert">
                            <div class="toast-icon">âœ…</div>
                            <div class="toast-body">
                                <strong>Â¡Entrega confirmada!</strong>
                                <br/>
                                <small>Se registrÃ³ exitosamente.</small>
                            </div>
                            <button type="button" class="btn-close btn-close-white btn-sm"
                                    onclick="this.closest('.insa-toast-container').remove()"/>
                        </div>
                    </div>
                </t>
            </div>
        </t>
    </template>

</odoo>
