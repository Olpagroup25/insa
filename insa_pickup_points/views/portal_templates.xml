<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ============================================================ -->
    <!-- Portal Home: add "Mis Entregas" card                         -->
    <!-- ============================================================ -->
    <template id="portal_my_home_pickup"
              name="Portal: Puntos de Retiro"
              inherit_id="portal.portal_my_home"
              priority="40">
        <xpath expr="//div[hasclass('o_portal_docs')]" position="inside">
            <t t-call="portal.portal_docs_entry">
                <t t-set="icon" t-value="'/insa_pickup_points/static/src/img/pickup_icon.svg'"/>
                <t t-set="title">Entregas en Punto de Retiro</t>
                <t t-set="text">Gestioná las entregas asignadas a tu punto de retiro</t>
                <t t-set="url" t-value="'/my/pickup/orders'"/>
                <t t-set="placeholder_count" t-value="'pickup_count'"/>
            </t>
        </xpath>
    </template>

    <template id="portal_my_home_pickup_counter"
              name="Portal: Pickup Counter"
              inherit_id="portal.portal_my_home_counters"
              priority="40">
        <xpath expr="//t[@t-call='portal.portal_docs_entry'][last()]" position="after">
            <!-- Counter badge for pickup orders -->
        </xpath>
    </template>

    <!-- ============================================================ -->
    <!-- List View: /my/pickup/orders                                 -->
    <!-- ============================================================ -->
    <template id="portal_pickup_orders" name="Portal: Entregas Punto de Retiro">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="1"/>

            <t t-call="portal.portal_searchbar">
                <t t-set="title">Entregas en Punto de Retiro</t>
            </t>

            <t t-if="not pickings">
                <div class="alert alert-info text-center mt-3" role="alert">
                    <p class="mb-0">
                        <strong>No hay entregas</strong> asignadas a tu punto de retiro con el filtro seleccionado.
                    </p>
                </div>
            </t>

            <t t-if="pickings">
                <div class="table-responsive">
                    <table class="table table-hover o_portal_my_doc_table">
                        <thead>
                            <tr>
                                <th>Referencia</th>
                                <th>Cliente</th>
                                <th>Fecha Programada</th>
                                <th>Origen</th>
                                <th class="text-center">Estado Entrega</th>
                                <th class="text-center">Confirmación</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="pickings" t-as="picking">
                                <tr>
                                    <td>
                                        <a t-attf-href="/my/pickup/orders/#{picking.id}">
                                            <t t-out="picking.name"/>
                                        </a>
                                    </td>
                                    <td>
                                        <t t-out="picking.partner_id.name"/>
                                    </td>
                                    <td>
                                        <t t-out="picking.scheduled_date" t-options="{'widget': 'date'}"/>
                                    </td>
                                    <td>
                                        <t t-out="picking.origin or ''"/>
                                    </td>
                                    <td class="text-center">
                                        <span t-if="picking.state == 'assigned'"
                                              class="badge rounded-pill text-bg-warning">
                                            Listo para entregar
                                        </span>
                                        <span t-if="picking.state == 'done'"
                                              class="badge rounded-pill text-bg-success">
                                            Realizado
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <span t-if="picking.pickup_confirmed"
                                              class="badge rounded-pill text-bg-success">
                                            <i class="fa fa-check"/> Confirmado
                                        </span>
                                        <span t-else=""
                                              class="badge rounded-pill text-bg-secondary">
                                            Pendiente
                                        </span>
                                    </td>
                                </tr>
                            </t>
                        </tbody>
                    </table>
                </div>

                <div t-if="pager" class="o_portal_pager text-center mt-3">
                    <t t-call="portal.pager"/>
                </div>
            </t>
        </t>
    </template>

    <!-- ============================================================ -->
    <!-- Detail View: /my/pickup/orders/<id>                          -->
    <!-- ============================================================ -->
    <template id="portal_pickup_order_detail" name="Portal: Detalle Entrega Punto de Retiro">
        <t t-call="portal.portal_layout">
            <t t-set="o_portal_fullwidth_alert" groups="base.group_user">
                <t t-call="portal.portal_back_in_edit_mode">
                    <t t-set="backend_url"
                       t-value="'/odoo/inventory/delivery/%s' % picking.id"/>
                </t>
            </t>

            <div class="container py-4">
                <!-- Breadcrumb -->
                <div class="row mb-3">
                    <div class="col">
                        <a href="/my/pickup/orders" class="btn btn-sm btn-outline-secondary">
                            <i class="fa fa-arrow-left"/> Volver al listado
                        </a>
                    </div>
                </div>

                <!-- Success alert after confirmation -->
                <t t-if="request.params.get('confirmed')">
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <strong>¡Entrega confirmada!</strong> La entrega fue marcada como confirmada exitosamente.
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"/>
                    </div>
                </t>

                <!-- Header -->
                <div class="row">
                    <div class="col-12">
                        <h3>
                            <t t-out="picking.name"/>
                            <span t-if="picking.pickup_confirmed"
                                  class="badge text-bg-success ms-2">
                                <i class="fa fa-check"/> Confirmado
                            </span>
                            <span t-else=""
                                  class="badge text-bg-warning ms-2">
                                Pendiente de confirmación
                            </span>
                        </h3>
                    </div>
                </div>

                <!-- Info cards -->
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header">
                                <strong>Información de la Entrega</strong>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm table-borderless mb-0">
                                    <tr>
                                        <td class="fw-bold" style="width: 40%;">Referencia:</td>
                                        <td><t t-out="picking.name"/></td>
                                    </tr>
                                    <tr>
                                        <td class="fw-bold">Origen:</td>
                                        <td><t t-out="picking.origin or '-'"/></td>
                                    </tr>
                                    <tr>
                                        <td class="fw-bold">Fecha Programada:</td>
                                        <td>
                                            <t t-out="picking.scheduled_date"
                                               t-options="{'widget': 'datetime'}"/>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="fw-bold">Estado:</td>
                                        <td>
                                            <span t-if="picking.state == 'assigned'"
                                                  class="badge text-bg-warning">Listo</span>
                                            <span t-if="picking.state == 'done'"
                                                  class="badge text-bg-success">Realizado</span>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header">
                                <strong>Cliente</strong>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm table-borderless mb-0">
                                    <tr>
                                        <td class="fw-bold" style="width: 40%;">Nombre:</td>
                                        <td><t t-out="picking.partner_id.name"/></td>
                                    </tr>
                                    <tr t-if="picking.partner_id.phone">
                                        <td class="fw-bold">Teléfono:</td>
                                        <td><t t-out="picking.partner_id.phone"/></td>
                                    </tr>
                                    <tr t-if="picking.partner_id.mobile">
                                        <td class="fw-bold">Celular:</td>
                                        <td><t t-out="picking.partner_id.mobile"/></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Products table -->
                <div class="card mt-3">
                    <div class="card-header">
                        <strong>Productos a Entregar</strong>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Producto</th>
                                    <th class="text-end">Cantidad Demandada</th>
                                    <th class="text-end">Cantidad Realizada</th>
                                    <th>Unidad</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="picking.move_ids" t-as="move">
                                    <tr>
                                        <td><t t-out="move.product_id.name"/></td>
                                        <td class="text-end">
                                            <t t-out="move.product_uom_qty"
                                               t-options="{'widget': 'float', 'precision': 2}"/>
                                        </td>
                                        <td class="text-end">
                                            <t t-out="move.quantity"
                                               t-options="{'widget': 'float', 'precision': 2}"/>
                                        </td>
                                        <td><t t-out="move.product_uom.name"/></td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Confirmation section -->
                <div class="mt-4 text-center">
                    <t t-if="not picking.pickup_confirmed">
                        <div class="card border-primary">
                            <div class="card-body">
                                <h5 class="card-title text-primary">
                                    <i class="fa fa-truck"/> Confirmar Entrega
                                </h5>
                                <p class="card-text text-muted">
                                    Al confirmar, indicás que el cliente ya retiró los productos de tu punto de retiro.
                                </p>
                                <form t-attf-action="/my/pickup/orders/#{picking.id}/confirm"
                                      method="POST">
                                    <input type="hidden" name="csrf_token"
                                           t-att-value="request.csrf_token()"/>
                                    <button type="submit"
                                            class="btn btn-primary btn-lg"
                                            onclick="return confirm('¿Confirmás que el cliente retiró los productos?');">
                                        <i class="fa fa-check"/> Confirmar Entrega
                                    </button>
                                </form>
                            </div>
                        </div>
                    </t>
                    <t t-else="">
                        <div class="card border-success">
                            <div class="card-body text-success">
                                <h5 class="card-title">
                                    <i class="fa fa-check-circle"/> Entrega Confirmada
                                </h5>
                                <p class="mb-1">
                                    Confirmado el
                                    <t t-out="picking.pickup_confirmed_date"
                                       t-options="{'widget': 'datetime'}"/>
                                </p>
                                <p class="mb-0" t-if="picking.pickup_confirmed_by">
                                    por <t t-out="picking.pickup_confirmed_by.name"/>
                                </p>
                            </div>
                        </div>
                    </t>
                </div>
            </div>
        </t>
    </template>

</odoo>
